var TB=TB||{};TB.Uploader=function(){var h=YAHOO.util,c=h.Dom,a=h.Event,e=YAHOO.lang;var b=(YAHOO.env.ua.gecko&&window.console)?console.log:function(){};var d={swfUrl:"uploader.swf",container:null,buttonSkin:"",forceTransparent:false,allowMultipleFiles:true,fileFilters:[{description:"\u6240\u6709\u6587\u4ef6 (*.*)",extensions:"*.*"}],uploadForm:"J_UploadForm",uploadList:"J_UploadList",uploadBtn:"J_UploadAll"};var g=function(i){this.config=e.merge(d,i||{});f.call(this)};e.augmentProto(g,h.EventProvider);function f(){var j=this.config;YAHOO.widget.Uploader.SWFURL=j.swfUrl;this._uploader=new YAHOO.widget.Uploader(j.container,j.buttonSkin,j.forceTransparent);this.uploadList=c.get(j.uploadList);this.uploadForm=c.get(j.uploadForm);a.on(this.uploadForm,"submit",function(l){a.preventDefault(l);this.uploadAll()},this,true);this.uploadBtn=c.get(j.uploadBtn);this.selectBtn=c.get(j.container);this.uploadTimeout=this.uploadForm.uploadTimeout.value||60;var k=this.uploadForm.needValidate;a.on(k,"click",function(){for(var l in this.fileList){this.validateItem(l)}this.fireEvent("fileListChange")},this,true);var i=this.uploadForm.batchPublish;a.on(i,"click",function(){this.batchPublish=i.checked},this,true);this.batchPublish=i.checked;this._uploader.addListener("contentReady",function(){this.setAllowMultipleFiles(j.allowMultipleFiles);this.setFileFilters(j.fileFilters)});this._uploader.addListener("fileSelect",function(l){this.fileList=l.fileList;this.onFileSelect(l.fileList)},this,true);this._uploader.addListener("uploadStart",function(l){this.onUploadStart(l.id)},this,true);this._uploader.addListener("uploadProgress",function(l){this.onUploadProgress(l.id,l.bytesLoaded,l.bytesTotal)},this,true);this._uploader.addListener("uploadCompleteData",function(l){this.onUploadComplete(l.id,l.data)},this,true);this._uploader.addListener("uploadError",function(l){this.onUploadError(l.id,l.status)},this,true);this._uploader.addListener("uploadCancel",function(l){this.onUploadCancel(l.id)},this,true);this.createEvent("fileListChange");this.createEvent("uploadCompleteAll")}e.augmentObject(g.prototype,{uploadAll:function(){this.uploadedFilesNum=0;this.uploadFailedNum=0;var l=c.getElementsByClassName("warning","li",this.uploadList);for(var m=0,j=l.length;m<j;++m){this.removeFile(l[m].id)}this._uploader.setSimUploadLimit(this.totalFilesNum<5?this.totalFilesNum:5);var k=this.uploadForm.action;var o=this.uploadForm.getAttribute("method")||"POST";this.batchPublishId=this.batchPublish?new Date().getTime():0;var n={needValidate:this.needValidate,batchPublishId:this.batchPublishId};b(e.dump(n));this._uploader.uploadAll(k,o,n);c.addClass(this.uploadForm,"ui-disabled");if(this.uploadForm.needValidate){this.uploadForm.needValidate.setAttribute("disabled","disabled")}if(this.uploadForm.batchPublish){this.uploadForm.batchPublish.setAttribute("disabled","disabled")}this._uploader.disable();this.setUploadBtnStatus(false)},onFileSelect:function(l){var k=c.get("tmpl-upload-item");b("onFileSelect: fileList = "+e.dump(l));var j=this._getTotalFilesNum();for(var p=0;p<j;++p){var o=l["file"+p];if(c.get(o.id)){continue}var n=k.innerHTML.replace("%filename",o.name);n=n.replace("%filesize",this._getFileSize(o.size));var m=k.cloneNode(false);m.id=o.id;m.innerHTML=n;(function(r,q){var i=c.getElementsByClassName("J_RemoveFile","a",q)[0];a.on(i,"click",function(s){a.preventDefault(s);r.removeFile(c.getAncestorByTagName(this,"li").id)})})(this,m);this.uploadList.appendChild(m);this.validateItem(o.id)}this.onFileListChange()},onFileListChange:function(){this.totalFilesSize=this._getTotalFilesSize();this.totalFilesNum=this._getTotalFilesNum();this.fireEvent("fileListChange")},onUploadStart:function(i){b("upload started");c.setAttribute(c.get(i),"class","processing");e.later(this.uploadTimeout*1000,this,function(){if(this.isOnUploading(i)){this._uploader.cancel(i);this.onUploadCancel(i)}})},onUploadProgress:function(j,n,m){b("on processing");var k=c.get(j);var l=n/m;var i=-795+Math.round(340*l);c.setStyle(k,"background-position",i+"px 0")},onUploadComplete:function(i,k){b("upload complete. responseData is "+k);var j=c.get(i);c.removeClass(j,"processing");c.setStyle(j,"background-position","");if(!e.JSON.isValid(k)){this.showResponse(i,{result:"0",msg:"\u670d\u52a1\u5668\u8fd4\u56de\u7684\u4fe1\u606f\u4e0d\u662f\u6709\u6548\u7684JSON\u683c\u5f0f\uff1a\n\n"+k})}else{this.showResponse(i,e.JSON.parse(k))}this.checkUploadAll()},onUploadError:function(j,i){b("error occurs. status message: "+i);this.showResponse(j,{result:"0",msg:i});this.checkUploadAll()},onUploadCancel:function(i){this.onUploadError(i,"\u4e0a\u4f20\u65f6\u95f4\u8d85\u65f6\uff0c\u4e0d\u80fd\u8d85\u8fc7 "+this.uploadTimeout+"s")},checkUploadAll:function(){this.uploadedFilesNum++;if(this.uploadedFilesNum==this.totalFilesNum){if(!this.batchPublish){this.fireEvent("uploadCompleteAll")}else{this.sendPublishRequest()}}},sendPublishRequest:function(){var p=c.getElementsByClassName("wait-to-publish","li",this.uploadList).length==this.totalFilesNum;b("sendPublishRequest: isAllOk = "+p);if(p){var k="batchPublishId="+this.batchPublishId+"&fileServeIds=";var m=c.getChildren(this.uploadList);for(var l=1,j=m.length;l<j;++l){k+=m[l].getAttribute("serveId");if(l!=j-1){k+=","}}b("postData"+k);var o={success:function(t){var s=t.argument;b("o.responseText: "+t.responseText);var q=e.JSON.parse(t.responseText);if(q.result=="4"){n(s,q.msg)}else{for(var r in q){var i=s.getFileItemByServeId(r);s.showResponse(i,{result:"1",msg:q[r]})}}s.fireEvent("uploadCompleteAll")},failure:function(i){b("o.responseText: "+i.responseText);n(i.argument,"\u53d1\u5e03\u65f6\u51fa\u95ee\u9898\u4e86");this.fireEvent("uploadCompleteAll")},argument:this};b(this.uploadForm.publishUrl.value);h.Connect.asyncRequest("POST",this.uploadForm.publishUrl.value,o,k)}else{this.fireEvent("uploadCompleteAll")}function n(u,t){var s=c.getChildren(u.uploadList);for(var r=1,q=s.length;r<q;++r){u.showResponse(s[r],{result:"4",msg:t})}u.uploadFailedNum=u.totalFilesNum}},validateItem:function(j){var k=this.uploadForm.needValidate;this.needValidate=k?k.checked:true;if(this.needValidate){var i=((this.uploadForm.fileSizeLimit||0).value)||2;if(this.fileList[j].size>1024*1024*i){this.showResponse(j,{result:"2",msg:"\u6587\u4ef6\u5927\u5c0f\u4e0d\u80fd\u8d85\u8fc7"+i+"M\uff0c\u8bf7\u4ece\u5217\u8868\u4e2d\u79fb\u9664\u3002"})}}else{this.showResponse(j,{result:"",msg:""});c.setAttribute(c.get(j),"class","default")}},setUploadBtnStatus:function(i){if(i){c.removeClass(this.uploadBtn,"disabled");this.uploadBtn.removeAttribute("disabled")}else{c.addClass(this.uploadBtn,"disabled");this.uploadBtn.setAttribute("disabled","disabled")}},showResponse:function(i,l){var k=c.get(i);if(!k){b("fileId: "+i+" \u4e0d\u5b58\u5728");return}b("response: "+e.dump(l));var j=l.result;var n=l.msg;var o="";switch(j){case"0":o="error";break;case"1":o="ok";break;case"2":o="warning";break;case"3":o="wait-to-publish";break;case"4":o="error";break}c.setAttribute(k,"class",o);var m=c.getElementsByClassName("msg","*",i)[0];if(m){if(n.indexOf("http")==0){n='<input type="text" class="url" onclick="javascript: this.select()" value="'+n+'" />'}m.innerHTML=n}if(j==2||j==0){this.uploadFailedNum++}if(this.batchPublish&&typeof l.fileServeId!="undefined"){k.setAttribute("serveId",l.fileServeId)}},removeFile:function(i){this._uploader.removeFile(i);delete this.fileList[i];this.uploadList.removeChild(c.get(i));this.onFileListChange()},reset:function(){for(var i in this.fileList){this.uploadList.removeChild(c.get(i))}this.fileList=null;this.totalFilesNum=0;this.totalFilesSize=0;this.fireEvent("fileListChange");c.removeClass(this.uploadForm,"ui-disabled");if(this.uploadForm.needValidate){this.uploadForm.needValidate.removeAttribute("disabled")}if(this.uploadForm.batchPublish){this.uploadForm.batchPublish.removeAttribute("disabled")}if(YAHOO.env.ua.ie){this._uploader.clearFileList();this._uploader.enable()}},isOnUploading:function(i){return c.hasClass(i,"processing")},getFileItemByServeId:function(m){var l=c.getChildren(this.uploadList);for(var k=1,j=l.length;k<j;++k){if(l[k].getAttribute("serveId")==m){return l[k]}}return null},_getFileSize:function(i){if(i<1024){return i+" B"}i=i/1024;if(i<1024){return i.toFixed(1)+" KB"}return(i/1024).toFixed(1)+" MB"},_getTotalFilesSize:function(){var j=0;for(var i in this.fileList){j+=this.fileList[i].size}return this._getFileSize(j)},_getTotalFilesNum:function(){var j=0;for(var i in this.fileList){if(this.fileList[i]){j++}}return j}});return g}();YAHOO.util.Event.onDOMReady(function(){var h=YAHOO.util,c=h.Dom,b=h.Event;var f=new TB.Uploader({swfUrl:TB.Uploader.assetsConfig.swfUrl,container:"J_UploadFlashBox",buttonSkin:TB.Uploader.assetsConfig.buttonSkin,allowMultipleFiles:true,fileFilters:[{description:"\u56fe\u7247\u6216Flash\u6587\u4ef6 (*.JPG;*.PNG;*.GIF;*.SWF)",extensions:"*.jpg;*.png;*.gif;*.swf"}]});var e=c.get("J_TotalFilesSize");var d=c.get("J_TotalFilesNum");f.subscribe("fileListChange",function(){e.innerHTML=this.totalFilesSize||"0 B";d.innerHTML=this.totalFilesNum||0;var i=c.getElementsByClassName("default","li",this.uploadList).length-1>0;this.setUploadBtnStatus(i)});var g=c.getElementsByClassName("upload-controls","div","J_UploadForm")[0];var a=c.getElementsByClassName("upload-result","div","J_UploadForm")[0];f.subscribe("uploadCompleteAll",function(){c.setStyle(this.selectBtn.parentNode,"display","none");c.addClass(g,"hidden");c.removeClass(a,"hidden");if(this.uploadFailedNum){c.get("J_UploadFailedNum").innerHTML=this.uploadFailedNum;c.addClass(a,"error-result")}else{c.addClass(a,"ok-result")}});c.getElementsByClassName("J_ResetUpload","a",a,function(i){b.on(i,"click",function(j){b.preventDefault(j);f.reset();c.setStyle(f.selectBtn.parentNode,"display","");c.removeClass(g,"hidden");c.removeClass(a,"ok-result");c.removeClass(a,"error-result");c.addClass(a,"hidden")})})});
